<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solax viewer (HTML + JS)</title>
<style>
  :root { --bg:#0b0f14; --card:#121822; --muted:#99a3b3; --ok:#1f9d55; --bad:#d64545; --accent:#3b82f6; }
  html,body{margin:0;background:var(--bg);color:#e8eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;}
  header{padding:16px 20px;border-bottom:1px solid #1d2633;}
  h1{margin:0;font-size:18px;font-weight:600}
  main{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:18px}
  fieldset{border:1px solid #1d2633;border-radius:12px;background:var(--card);padding:14px}
  legend{padding:0 6px;color:#c9d7ee}
  label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
  input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #253045;background:#0e1420;color:#e8eef7}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .actions{display:flex;gap:8px;margin-top:12px}
  button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  button.secondary{background:#263248}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:16px}
  .card{background:var(--card);border:1px solid #1d2633;border-radius:14px;padding:14px 16px}
  .card h3{margin:0 0 10px 0;font-size:14px;color:#c9d7ee}
  .kv{display:grid;grid-template-columns:auto 1fr auto;gap:8px 10px;align-items:center;font-size:14px}
  .dim{color:var(--muted);font-size:12px}
  .pill{font-variant-numeric:tabular-nums;background:#0e1420;border:1px solid #263148;border-radius:999px;padding:2px 8px}
  .bar{height:10px;background:#0e1420;border-radius:999px;border:1px solid #243049;overflow:hidden}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,#3b82f6,#22c55e)}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .footer{color:#7f8aa5;font-size:12px;margin-top:6px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header><h1>Solax – živá telemetrie (přes proxy.php)</h1></header>

<main>
  <section>
    <form id="cfg">
      <fieldset>
        <legend>Nastavení</legend>

        <!-- PROXY endpoint je napevno, uživatel zadává jen skutečné API -->
        <label>API URL (Solax reálné API)
          <input name="apiUrl" placeholder="http://solax-sim" />
        </label>

        <label><input type="checkbox" name="sendPwd" /> Posílat heslo z prohlížeče (nedoporučeno)</label>
        <div id="pwdWrap" style="display:none">
          <label>Heslo k API (pokud to proxy neřeší sama)
            <input name="passwd" type="password" autocomplete="current-password" />
          </label>
        </div>

        <label>Proxy (pokud není Solax http API přímo dostupné )
          <input name="proxy" placeholder="http://some-proxy:3128"" />
        </label>

        <div class="row">
          <div>
            <label>Interval čtení (s)
              <input name="delay" type="number" min="1" value="4" />
            </label>
          </div>
          <div>
            <label>Debug (0/1/2)
              <input name="debuglevel" type="number" min="0" max="2" value="1" />
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Peak String 1 (W)
              <input name="peak1" type="number" min="0" value="4500" />
            </label>
          </div>
          <div>
            <label>Peak String 2 (W)
              <input name="peak2" type="number" min="0" value="0" />
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Max výkon měniče (W)
              <input name="maxPower" type="number" min="0" value="4500" />
            </label>
          </div>
          <div>
            <label>Max odběr domu (W)
              <input name="maxLoad" type="number" min="0" value="16000" />
            </label>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="start">Start</button>
          <button type="button" class="secondary" id="stop">Stop</button>
          <button type="button" class="secondary" id="save">Uložit nastavení</button>
        </div>

        <div class="footer">
          Proxy endpoint je napevno <span class="mono">proxy.php</span>.
          Z bezpečnostních důvodů je lepší, aby <span class="mono">proxy.php</span> heslo doplnila server-side.
        </div>
      </fieldset>
    </form>
  </section>

  <section>
    <div class="grid">
      <div class="card" id="card-panels">
        <h3>Panely</h3>
        <div class="kv">
          <div class="dim">Celkem</div><div class="bar"><i id="bar-pv-total" style="width:0%"></i></div><div class="pill"><span id="pv-total">0</span> W</div>
          <div class="dim">String 1</div><div class="bar"><i id="bar-pv-1" style="width:0%"></i></div><div class="pill"><span id="pv-1">0</span> W</div>
          <div class="dim">String 2</div><div class="bar"><i id="bar-pv-2" style="width:0%"></i></div><div class="pill"><span id="pv-2">0</span> W</div>
          <div class="dim">Výroba DC dnes</div><div></div><div class="pill"><span id="pv-dc-today">0.0</span> kWh</div>
        </div>
      </div>

      <div class="card" id="card-batt">
        <h3>Baterie</h3>
        <div class="kv">
          <div class="dim">SoC</div><div class="bar"><i id="bar-batt-soc" style="width:0%"></i></div><div class="pill"><span id="batt-soc">0</span> %</div>
          <div class="dim">Teplota</div><div></div><div class="pill"><span id="batt-temp">0</span> °C</div>
          <div class="dim">Kapacita</div><div class="bar"><i id="bar-batt-cap" style="width:0%"></i></div><div class="pill"><span id="batt-cap">0.0</span> kWh</div>
          <div class="dim">Směr</div><div></div><div id="batt-power" class="pill">0 W</div>
          <div class="dim">Dnes nabito</div><div></div><div class="pill"><span id="batt-in">0.0</span> kWh</div>
          <div class="dim">Dnes vybito</div><div></div><div class="pill"><span id="batt-out">0.0</span> kWh</div>
        </div>
      </div>

      <div class="card" id="card-inv">
        <h3>Střídač <span id="inv-mode" class="dim"></span></h3>
        <div class="kv">
          <div class="dim">Teplota</div><div></div><div class="pill"><span id="inv-temp">0</span> °C</div>
          <div class="dim">Výkon</div><div class="bar"><i id="bar-inv" style="width:0%"></i></div><div class="pill"><span id="inv-pwr">0</span> W</div>
          <div class="dim">L1</div><div></div><div class="pill"><span id="l1">0</span> W</div>
          <div class="dim">L2</div><div></div><div class="pill"><span id="l2">0</span> W</div>
          <div class="dim">L3</div><div></div><div class="pill"><span id="l3">0</span> W</div>
          <div class="dim">AC výroba dnes</div><div></div><div class="pill"><span id="inv-ac-today">0.0</span> kWh</div>
        </div>
      </div>

      <div class="card" id="card-grid">
        <h3>Distribuční síť</h3>
        <div class="kv">
          <div class="dim">Směr</div><div></div><div id="grid-dir" class="pill">0 W</div>
          <div class="dim">Dnes odebráno</div><div></div><div class="pill"><span id="grid-in">0.00</span> kWh</div>
          <div class="dim">Dnes dodáno</div><div></div><div class="pill"><span id="grid-out">0.00</span> kWh</div>
        </div>
      </div>

      <div class="card" id="card-home">
        <h3>Dům</h3>
        <div class="kv">
          <div class="dim">Aktuální odběr</div><div class="bar"><i id="bar-home" style="width:0%"></i></div><div class="pill"><span id="home-load">0</span> W</div>
          <div class="dim">Dnes spotřeba</div><div></div><div class="pill"><span id="home-cons">0.0</span> kWh</div>
          <div class="dim">Soběstačnost</div><div class="bar"><i id="bar-self" style="width:0%"></i></div><div class="pill"><span id="self">0</span> %</div>
        </div>
      </div>

      <div class="card">
        <h3>Systém</h3>
        <div class="kv">
          <div class="dim">Sériové číslo</div><div></div><div class="pill mono" id="sn">—</div>
          <div class="dim">Čas</div><div></div><div class="pill mono" id="dt">—</div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Proxy endpoint napevno ===== */
const PROXY_ENDPOINT = 'proxy.php';

/* ===== Helpery ===== */
function s16(x){ x = (Number(x)||0); return x>=32768 ? x-65536 : x; }
function u32(hi,lo){ return ((Number(hi)||0)*65536) + (Number(lo)||0); }
function s32(hi,lo){ const v = u32(hi,lo); return v>=2147483648 ? v-4294967296 : v; }

const INV_MODE = ["Waiting","Checking","Normal","Off","Permanent Fault","Updating","EPS Check","EPS Mode","Self Test","Idle","Standby"];
let timer = null;

const el = (id)=>document.getElementById(id);
const cfgForm = document.getElementById('cfg');
const pwdWrap = document.getElementById('pwdWrap');
cfgForm.sendPwd.addEventListener('change',()=>{ pwdWrap.style.display = cfgForm.sendPwd.checked ? 'block' : 'none'; });

(function loadCfg(){
  const saved = JSON.parse(localStorage.getItem('solaxCfg2')||'{}');
  for (const k of ['apiUrl','delay','debuglevel','peak1','peak2','maxPower','maxLoad','sendPwd','passwd', 'proxy']){
    if (saved[k]!==undefined) {
      if (k==='sendPwd') cfgForm[k].checked = !!saved[k];
      else cfgForm[k].value = saved[k];
    }
  }
  pwdWrap.style.display = cfgForm.sendPwd.checked ? 'block' : 'none';
})();

document.getElementById('save').onclick = ()=>{
  const o = formToCfg();
  localStorage.setItem('solaxCfg2', JSON.stringify(o));
  console.log('[CFG] uloženo', o);
};

document.getElementById('start').onclick = ()=> startPolling();
document.getElementById('stop').onclick = ()=> { if (timer) clearInterval(timer), timer=null; console.log('[POLL] stop'); };

function formToCfg(){
  const f = cfgForm;
  return {
    apiUrl: f.apiUrl.value.trim(),                 // ← reálné API (host:port + path)
    delay: Math.max(1, Number(f.delay.value)||4),
    debuglevel: Math.max(0, Math.min(2, Number(f.debuglevel.value)||0)),
    peak1: Number(f.peak1.value)||0,
    peak2: Number(f.peak2.value)||0,
    maxPower: Number(f.maxPower.value)||0,
    maxLoad: Number(f.maxLoad.value)||0,
    sendPwd: !!f.sendPwd.checked,
    passwd: f.passwd.value,
    proxy:  f.proxy.value
  };
}

/* ===== Volání proxy s předáním target URL + hesla ===== */
async function callProxy(cfg){
  if (!cfg.apiUrl) throw new Error('Není vyplněna API URL');
  const body = new URLSearchParams();
  body.set('target', cfg.apiUrl);
  body.set('proxy', cfg.proxy);
  body.set('optType', 'ReadRealTimeData');
  if (cfg.sendPwd && cfg.passwd) body.set('pwd', cfg.passwd);

  const res = await fetch(PROXY_ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
    body
  });

  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

/* ===== Zpracování odpovědi → status objekt ===== */
function buildStatus(o, cfg){
  const D = o.Data || [];
  const s = {
    SerNum:             o.sn ?? null,
    PowerDc1:           Number(D[14]||0),
    PowerDc2:           Number(D[15]||0),
    ProductionDC_Today: Number(D[82]||0)/10,
    YieldAC_Today:      Number(D[70]||0)/10,
    feedInPower:        s16(Number(D[34]||0)),
    _feedInPower:       s32(Number(D[34]||0), Number(D[35]||0)),
    totalGridIn:        u32(Number(D[93]||0), Number(D[92]||0))/100,
    totalGridOut:       u32(Number(D[91]||0), Number(D[90]||0))/100,
    load:               s16(Number(D[47]||0)),
    batteryPower:       s16(Number(D[41]||0)),
    totalChargedIn:     Number(D[79]||0)/10,
    totalChargedOut:    Number(D[78]||0)/10,
    batterySoC:         Number(D[103]||0),
    batteryCapacitykWh: Number(D[106]||0)/10,
    batteryTemp:        Number(D[105]||0),
    inverterTemp:       Number(D[54]||0),
    inverterPower:      s16(Number(D[9]||0)),
    inverterMode:       Number(D[19]||0),
    GridL1Power:        s16(Number(D[6]||0)),
    GridL2Power:        s16(Number(D[7]||0)),
    GridL3Power:        s16(Number(D[8]||0)),
    _Yield_Total:       u32(Number(D[68]||0), Number(D[69]||0))/10,
    _FeedInEnergy:      u32(Number(D[86]||0), Number(D[87]||0))/100,
    _ConsumeEnergy:     u32(Number(D[88]||0), Number(D[89]||0))/100,
    PowerDCtotal:       0,
    totalPeak:          (Number(cfg.peak1)||0) + (Number(cfg.peak2)||0)
  };
  s.PowerDCtotal = s.PowerDc1 + s.PowerDc2;
  const totalConsumption = (s.totalGridIn) + (s.YieldAC_Today) - (s.totalGridOut);
  const selfSuff = totalConsumption === 0 ? 0 : ((s.YieldAC_Today - s.totalGridOut) * 100 / totalConsumption);
  s.totalConsumption = totalConsumption;
  s.selfSufficiencyRate = Math.max(0, Math.min(100, Math.round(selfSuff)));
  return s;
}

/* ===== Render ===== */
function pct(val, max){ max = Number(max)||0; if (max<=0) return 0; return Math.max(0, Math.min(100, (val/max)*100)); }
function fmtN(x, digits=0){ return (Number(x)||0).toLocaleString('cs-CZ', { maximumFractionDigits: digits, minimumFractionDigits: digits }); }

function render(s, cfg){
  const now = new Date();
  el('sn').textContent = s.SerNum ?? '—';
  el('dt').textContent = now.toLocaleString('cs-CZ');

  // Panely
  el('pv-total').textContent = fmtN(s.PowerDCtotal,0);
  el('pv-1').textContent = fmtN(s.PowerDc1,0);
  el('pv-2').textContent = fmtN(s.PowerDc2,0);
  el('pv-dc-today').textContent = fmtN(s.ProductionDC_Today,1);
  el('bar-pv-total').style.width = pct(s.PowerDCtotal, s.totalPeak) + '%';
  el('bar-pv-1').style.width = pct(s.PowerDc1, cfg.peak1) + '%';
  el('bar-pv-2').style.width = pct(s.PowerDc2, cfg.peak2) + '%';

  // Baterie
  el('batt-soc').textContent = fmtN(s.batterySoC,0);
  el('batt-temp').textContent = fmtN(s.batteryTemp,0);
  el('batt-cap').textContent = fmtN(s.batteryCapacitykWh,1);
  el('batt-in').textContent = fmtN(s.totalChargedIn,1);
  el('batt-out').textContent = fmtN(s.totalChargedOut,1);
  const bp = Number(s.batteryPower)||0;
  const battEl = el('batt-power');
  battEl.textContent = (bp>=0 ? 'nabíjení ' : 'vybíjení ') + fmtN(Math.abs(bp),0) + ' W';
  battEl.classList.toggle('ok', bp>=0);
  battEl.classList.toggle('bad', bp<0);
  el('bar-batt-soc').style.width = Math.max(0, Math.min(100, s.batterySoC)) + '%';
  el('bar-batt-cap').style.width = Math.max(0, Math.min(100, (s.batteryCapacitykWh/ (cfg.battCapacity || s.batteryCapacitykWh || 1))*100)) + '%';

  // Střídač
  el('inv-mode').textContent = `[${INV_MODE[s.inverterMode] ?? s.inverterMode}]`;
  el('inv-temp').textContent = fmtN(s.inverterTemp,0);
  el('inv-pwr').textContent = fmtN(s.inverterPower,0);
  el('bar-inv').style.width = pct(s.inverterPower, cfg.maxPower) + '%';
  el('l1').textContent = fmtN(s.GridL1Power,0);
  el('l2').textContent = fmtN(s.GridL2Power,0);
  el('l3').textContent = fmtN(s.GridL3Power,0);
  el('inv-ac-today').textContent = fmtN(s.YieldAC_Today,1);

  // Síť
  const fp = Number(s.feedInPower)||0;
  const gridEl = el('grid-dir');
  gridEl.textContent = (fp<0 ? 'odběr ' : 'dodávka ') + fmtN(Math.abs(fp),0) + ' W';
  gridEl.classList.toggle('bad', fp<0);
  gridEl.classList.toggle('ok', fp>=0);
  el('grid-in').textContent = fmtN(s.totalGridIn,2);
  el('grid-out').textContent = fmtN(s.totalGridOut,2);

  // Dům
  el('home-load').textContent = fmtN(s.load,0);
  el('bar-home').style.width = pct(s.load, cfg.maxLoad) + '%';
  el('home-cons').textContent = fmtN(s.totalConsumption,1);
  el('bar-self').style.width = Math.max(0, Math.min(100, s.selfSufficiencyRate)) + '%';
  el('self').textContent = fmtN(s.selfSufficiencyRate,0);
}

/* ===== Polling ===== */
function startPolling(){
  const cfg = formToCfg();
  localStorage.setItem('solaxCfg2', JSON.stringify(cfg));
  if (timer) clearInterval(timer);
  console.log('[POLL] start', { target: cfg.apiUrl, proxy: PROXY_ENDPOINT });

  const tick = async ()=>{
    try{
      const raw = await callProxy(cfg);
      if (cfg.debuglevel>0) console.log('[RAW]', raw);
      const status = buildStatus(raw, cfg);
      if (cfg.debuglevel>1) console.log('[STATUS]', status);
      render(status, cfg);
    }catch(e){
      console.warn('Chyba čtení', e);
      el('sn').textContent = '— (chyba spojení)';
      el('dt').textContent = new Date().toLocaleString('cs-CZ');
    }
  };

  tick();
  timer = setInterval(tick, cfg.delay*1000);
}
</script>
</body>
</html>
